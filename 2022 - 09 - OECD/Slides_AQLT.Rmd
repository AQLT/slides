---
title: |
 | R and JDemetra+ 3.0: 
 | A new toolbox around seasonal adjustment and time series analysis
subtitle: "2^nd^WS Time Series Methods for Official Statistics"
author: "Alain Quartier-la-Tente"
departement: "Friday 23 September 2022"
division: | 
    | Insee
    | Session 10: Seasonal and Calendar Adjustment
logo: "img/logobeamer.png"
automaticcontents: false
output:
    beamer_presentation:
        template: template_Beamer.tex
        keep_tex: yes
        theme: TorinoTh
        slide_level: 3
        includes:
          in_header: preamble_beamer.tex
themeoptions: "coding=utf8,language=english"
classoption: 'usepdftitle=false,french' #handout
fontsize: 10pt
bibliography: [biblio.bib]
biblio-style: unsrtnat
natbiboptions: [numbers]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = F, eval = F,
                      fig.align = 'center',
                      fig.path = "img/markdown-")
library(knitr)
library(kableExtra)
library(rjdfilters)
library(microbenchmark)
library(ggplot2)
fig.ext <- "pdf"
# load(file = "tables.RData")
# mae <- readRDS("tables_revisions.RDS")$MAE
is_html <- knitr::is_html_output()
is_latex <- knitr::is_latex_output()
fig.ext = "pdf"
if(is_html){
    fa_arrow_circle_right <- '<i class="fas fa-arrow-circle-right"></i>'
    fa_r_project <- '<i class="fab fa-r-project"></i>'
}else {
    if(is_latex){
        fa_arrow_circle_right <- "\\faIcon{arrow-circle-right}"
        fa_r_project <- "\\faIcon{r-project}"
    }else {
        fa_arrow_circle_right <- "->"
        fa_r_project <- 'R'
    }
}
options(width = 60)
def.par <- par(no.readonly = TRUE)
```

# Introduction

### Introduction (1)

-   In March 2019, `RJDemetra` was published on CRAN:

    -   first R package that enables to use TRAMO-SEATS

    -   faster than existing R packages on seasonal adjustment

    -   enables to interact with JDemetra+ "workspaces" used in production

. . .

-   With the development of JDemetra+ 3.0, more than 11 R packages are being developped! Not only on seasonal adjustment!

### Introduction (2)

They are all available in GitHub and require Java $\geq$ 17 (see for example installation manual of `RJDemetra`: <https://github.com/jdemetra/rjdemetra/wiki/Installation-manual>):

```{r, eval=FALSE}
# install.packages("remotes")
remotes::install_github("palatej/rjd3toolkit")
remotes::install_github("palatej/rjd3modelling")
remotes::install_github("palatej/rjd3sa")
remotes::install_github("palatej/rjd3arima")
remotes::install_github("palatej/rjd3x13")
remotes::install_github("palatej/rjd3tramoseats")
remotes::install_github("palatej/rjdemetra3")
remotes::install_github("palatej/rjdfilters")
remotes::install_github("palatej/rjd3sts")
remotes::install_github("palatej/rjd3highfreq")
remotes::install_github("palatej/rjd3bench")
```

### Introduction (3)

![](img/diag.pdf)

If you don't know what to do: install all of them!


# Utility packages

## rjd3toolkit

### rjd3toolkit

Contains several utility functions used in other `rjd` packages and several functions to perform tests:

- Normality tests: Bowman-Shenton (`bowmanshenton()`), Doornik-Hansen (`doornikhansen()`), Jarque-Bera (`jarquebera()`)

- \bclampe Runs tests (randomness of data):  mean or the median (`testofruns()`) or up and down runs test (`testofupdownruns()`) -> not available in R

- autocorrelations function (usual, inverse, partial)

- `aggregate` to aggregate a time serie to a higher frequency

## rjd3modelling
### rjd3modelling

- \bclampe create user-defined calendar and trading-days regressors

- \bclampe create outliers regressors (AO, LS, TC, SO, Ramp, intervention variables), calendar related regressors (stock, leap year, periodic dummies and contrasts, trigonometric variables) -> to be added quadratic ramps

- \bclampe  Range-mean regression test (to choose log transformation), Canova-Hansen (`td.ch()`) and trading-days f-test (`td.f()`)

## rjd3sa
### rjd3sa

Seasonality tests :

- Canova-Hansen (`seasonality.canovahansen()`)

- \bclampe X-12 combined test (`seasonality.combined()`)

- F-test on seasonal dummies (`seasonality.f()`)

- Friedman Seasonality Test (`seasonality.friedman()`)

- Kruskall-Wallis Seasonality Test (`seasonality.kruskalwallis()`)

- \bclampe Periodogram Seasonality Test (`seasonality.periodogram()`)

- QS Seasonality Test (`seasonality.qs()`)

# Seasonal adjustment packages


## rjd3arima
### rjd3arima

Utility functions used in `rjd3x13` and `rjd3tramoseats` to set the specification of the preprocessing:

`set_arima()`, `set_automodel()`, `set_basic()`, `set_easter()`, `set_estimate()`, `set_outlier()`, `set_tradingdays()`, `set_transform()`, `add_outlier()`, `add_ramp()` 

\bcinterdit `add_usrdefvar()` not yet available

. . .

Functions commons to RegARIMA and TRAMO

. . .

In `RJDemetra` you have one function to set the specification (`regarima_spec_x13()`, `regarima_spec_tramo()`, `x13_spec()` and `tramoseats_spec()`) now one function for each part of the specification


## rjd3x13
### rjd3x13

Main functions:

- Specification: created with `spec_x11_default()`, `spec_x13_default()`, `spec_regarima_default()` and customized with `rjd3arima` functions + `set_x11()`

- Apply model with `x11()`, `x13()`, `fast.x13()`, `regarima()`, `fast.regarima()`

- \bclampe Refresh policies: `regarima.refresh()` and `x13.refresh()`


### Performance

```{r performance, echo = FALSE, out.height="90%", message=FALSE}
m = readRDS("img/microbenchmark.RDS")
autoplot(m)+theme(axis.text=element_text(size=16),
        axis.title=element_text(size=16))
```


## rjd3tramoseats
### rjd3tramoseats

Main functions:

- Specification: created with `spec_tramoseats_default()`, `spec_tramo_default()` and customized with `rjd3arima` functions + `set_seats()`

- Apply model with `tramoseats()`, `fast.tramoseats()`, `tramo()`, `fast.tramo()`

- \bclampe Refresh policies: `tramo.refresh()` and `tramoseats.refresh()`

## rjdemetra3

### rjdemetra3

Functions to manipulate JDemetra+ workspaces:

- Still in construction: you can load an existing workspace but not create a new one

- Will contain all the functionalities of `rjdworkspace`

### rjd3highfreq

Seasonal adjustment of high frequency data :

- \bclampe fractional and multi airline decomposition 

- STL/Loess

- \bclampe Extension of X-11 decomposition with non integer periodicity

See Session 3: High Frequency Data


# Other packages

## rjd3sts

### rjd3sts

Interface to structural time series and state space models
Functions to manipulate JDemetra+ workspaces:

- Still in construction: you can load an existing workspace but not create a new one

- Will contain all the functionalities of `rjdworkspace`


## rjd3bench
### rjd3bench

Benchmarking and temporal disaggregation

Several examples here: https://github.com/palatej/test_rjd3bench

## rjdfilters

### `rjdfilters` (1)

- \bclampe easily create/combine/apply moving averages `moving_average()` (much more general than `stats::filter()`) and study their properties: plot coefficients (`plot_coef()`), gain (`plot_gain()`), phase-shift (`plot_phase()`) and different statics (`diagnostic_matrix()`)

. . .

- \bclampe trend-cycle extraction with different methods to treat endpoints: 

  - `lp_filter()` local polynomial filters of Proietti and Luati (2008) (including Musgrave): Henderson, Uniform, biweight, Trapezoidal, Triweight, Tricube, "Gaussian", Triangular, Parabolic (= Epanechnikov)  
  - `rkhs_filter()` Reproducing Kernel Hilbert Space (RKHS) of Dagum and Bianconcini (2008) with same kernels  
  - `fst_filter()` FST approach of Grun-Rehomme, Guggemos, and Ladiray (2018)  
  - `dfa_filter()` derivation of AST approach of Wildi and McElroy (2019)

. . .

- \bclampe change the filter used in X-11 for TC extraction


### Create moving average `moving_average()` {.allowframebreaks}

\footnotesize

(Recall: $B^iX_t=X_{t-p}$ and $F^iX_t=X_{t+p}$)
```{r}
library(rjdfilters)
m1 = moving_average(rep(1,3), lags = 1); m1 # Forward MA
m2 = moving_average(rep(1,3), lags = -1); m2 # centered MA
m1 + m2
m1 - m2
m1 * m2
```

Can be used to create all the MA of X-11:
```{r}
e1 <- moving_average(rep(1,12), lags = -6)
e1 <- e1/sum(e1)
e2 <- moving_average(rep(1/12, 12), lags = -5)
# used to have the 1rst estimate of the trend
tc_1 <- M2X12 <- (e1 + e2)/2
coef(M2X12) |> round(3)
si_1 <- 1 - tc_1
M3 <- moving_average(rep(1/3, 3), lags = -1)
M3X3 <- M3 * M3
# M3X3 moving average applied to each month
coef(M3X3) |> round(3)
M3X3_seasonal <- to_seasonal(M3X3, 12)
coef(M3X3_seasonal) |> round(3)
s_1 = M3X3_seasonal * si_1
s_1_norm = (1 - M2X12) * s_1
sa_1 <- 1 - s_1_norm
henderson_mm = moving_average(lp_filter(horizon = 6)$
                                  filters.coef[, "q=6"],
                              lags = -6)
tc_2 <- henderson_mm * sa_1
si_2 <- 1 - tc_2
M5 <- moving_average(rep(1/5, 5), lags = -2)
M5X5_seasonal <- to_seasonal(M5 * M5, 12)
s_2 = M5X5_seasonal * si_2
s_2_norm = (1 - M2X12) * s_2
sa_2 <- 1 - s_2_norm
tc_f <- henderson_mm * sa_2
```


```{r x11Filters,out.height="90%"}
par(mai = c(0.3, 0.3, 0.2, 0))
layout(matrix(c(1,1,2,3), 2, 2, byrow = TRUE))

plot_coef(tc_f);plot_coef(sa_2, col = "orange", add = TRUE)
legend("topleft", 
       legend = c("Final TC filter", "Final SA filter"),
       col= c("black", "orange"), lty = 1)
plot_gain(tc_f);plot_gain(sa_2, col = "orange", add = TRUE)
plot_phase(tc_f);plot_phase(sa_2, col = "orange", add = TRUE)
```

```{r,include = FALSE}
par(def.par)
```

### Apply a moving average

\footnotesize
```{r exApply,out.height="70%"}
y <- retailsa$AllOtherGenMerchandiseStores
trend <- y * tc_1
sa <- y * sa_1
plot(window(ts.union(y, trend, sa), start = 2000),
     plot.type = "single",
      col = c("black","orange", "lightblue"))
```

### Merci pour votre attention {.noframenumbering}

Package \faIcon{r-project}{}:

\href{https://github.com/palatej/rjdfilters}{\faGithub{} palatej/rjdfilters}

Version en dÃ©veloppement \href{https://github.com/AQLT/rjdfilters}{\faGithub{} AQLT/rjdfilters}

\faIcon{desktop} Codes : <https://github.com/AQLT/articles>
